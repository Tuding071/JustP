name: Android Build APK

on:
  push:
    tags:
      - 'v0.*'
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: '45 18 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Create dummy keystore
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v0.'))
        run: |
          keytool -genkeypair -v \
            -keystore dummy.keystore \
            -storepass android \
            -alias androidkey \
            -keypass android \
            -dname "CN=Android, OU=Android, O=Android, L=Unknown, ST=Unknown, C=US" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000

      - name: Build Release APK and Bundle
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v0.'))
        run: |
          ./gradlew assembleRelease bundleRelease \
            -Pandroid.injected.signing.store.file=${GITHUB_WORKSPACE}/dummy.keystore \
            -Pandroid.injected.signing.store.password=android \
            -Pandroid.injected.signing.key.alias=androidkey \
            -Pandroid.injected.signing.key.password=android

      - name: Build Debug APK (for PRs)
        if: github.event_name == 'pull_request'
        run: ./gradlew assembleDebug

      - name: Get current date time
        id: datetime
        run: |
          PH_TIME=$(TZ='Asia/Manila' date +'%Y%m%d_%H%M')
          echo "filename_time=$PH_TIME" >> $GITHUB_OUTPUT

      - name: Upload Release Artifacts
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v0.'))
        uses: actions/upload-artifact@v4
        with:
          name: release-build-${{ steps.datetime.outputs.filename_time }}
          path: |
            app/build/outputs/apk/**/release/*.apk
            app/build/outputs/bundle/**/*.aab
          retention-days: 30

      - name: Upload Debug Artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: debug-build-${{ steps.datetime.outputs.filename_time }}
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v0.')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            app/build/outputs/apk/**/release/*.apk
            app/build/outputs/bundle/**/*.aab
          prerelease: true
          draft: true
